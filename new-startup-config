(revision 2: can't use canned sandbox configs. cabal's is about to change.
also rename since the new cabal won't really be a sandbox as such, and arguably
stack already isn't. I will note that "sandbox" still applies based on the
original usage which I still want to support in here somehow, where it is
sandboxing multiple xmonad configs from each other for e.g. testing.)

xmonad sandbox/config directory support

build.config
   ${XDG_CONFIG_HOME:-$HOME/.config:${XDG_CONFIG_DIRS:-/etc/xdg}}/xmonad/build.config
   $HOME/Library/Preferences/xmonad/build.config
   $HOME/.xmonad/build.config

The first of these found is used, and defines the default location for other files;
this can be overridden via entries in build.config. If none has this then we repeat
looking for xmonad.hs and otherwise use defaults.

We do not use XDG_DATA_HOME / XDG_DATA_DIRS. Some contribs actually have a use for this,
all currently operating in an ad hoc manner. It is arguable whether xmonad.errors counts
as data or as cache. I'd been leaning toward cache but may change my mind. That said,
strict reading of XDG spec seems to agree that it should be cache. The local package tree
may also go here.

All other files are considered generated and belong in $XDG_CACHE_HOME, although it is
up to the ghc_template to enforce this.

The build.config is parsed with ReadP to avoid extra dependencies on a parser.

config = "%config/xmonad.hs" -- pathname to xmonad.hs
libs = "%[%d/lib:| d <- %(:)data]%config/lib" -- path to user supplied libraries
errors = "%cache/xmonad.errors" -- pathname to xmonad.errors
xmessage_file = "xmessage -in" -- command to run for xmessage; should be UTF8 aware
  -- (note that xmessage itself is not! ghc output will have noise.)
  -- filename is appended to this. It should output literally; Pango-based
  -- programs such as zenity should be told not to process markup.
  -- see https://github.com/geekosaur/xmonad.hs/blob/master/xmessage which
  -- might go into xmonad-contrib.
  -- This is mostly in here because the rebuild uses it to display errors.
  -- Strictly speaking it is not about build, and is intended to address contrib
  -- uses as well.
  -- Use %f for filename to allow e.g. sed pipeline, else it will be appended.
xmessage_short = "xmessage" -- as above but message is on command line
  -- message will be provided as a single parameter.
  -- Use %s for message, or it will be appended.
recompile = "%xmonad --recompile" -- command to recompile
  -- replacing hardcoded "xmonad --recompile". used by mod-q. the actual
  -- recompilation is controlled by ghc_template below.
  -- example usage: recompile = "stack exec -- xmonad --recompile"
restart = "%xmonad --restart" -- command to restart
  -- as above for recompile.
  -- this needs more thought as it's actually modifying what is currently a
  -- hardcoded script that uses them and xmessage (to alert if xmonad not on $PATH).
ghc_template = "" -- what is actually run to recompile, replacing hardcoded ghc invo
  -- the actual script is rather complex even before I make it work with
  -- sandboxes and such. see below.
environment = [] -- list of strings to be added to environment
  -- really a list of pairs of strings...
  -- environment = [("PATH","...")]
  -- @@@ is it worth spec-ing a list, for PATH-like things? given that one of the
  --     things you'd want to specify is the XDG dirs, but it's kinda too late
  --     for that. (Or is it, aside from $XDG_CONFIG_{HOME.DIRS}?)
xmonad = "xmonad" -- path to xmonad executable, available as %xmonad in commands
  -- NB. prefer fixing $PATH in environment[], this is a last resort
-- more to be added later?

@@@ xmonad's own recompile check expects to be able to find various files.
@@@ this means xmonad and all .hs files in all lib directories.

Strings can use %-escapes. Am considering also allowing $vars for the ones that
aren't shell commands; if I don't then there will be %-escape versions of the useful
ones. (Currently leaning away from $vars.)

Original %-escapes, from sandboxed xmonad configs (see script at end):
    %%      %
    %pid    process id
    %kind   which sandbox (empty, -test, ...)
    %arch   2nd component of executable name xmonad%kind-%arch-%os
    %os     3rd component of executable name xmonad%kind-%arch-%os
    %hc     path to compiler
    %hcver  compiler version

Likely additions:
    %home   home dir for files vs. commands (the latter can use ~ or $HOME)
    %libs   :-separated list of library directories (see libs above)
    %f      filename for xmessage_file
    %s      message for xmessage_short
    %\...   (top level of commands only) suppress quoting of result
    %$...   environment variable

This must be expanded for the new usage. in particular handling libs will be fun...
%[-i%x | x <- %(:)libs] ? Spaces are significant between the [ and |.

May also want a subset of shell expansions, so e.g. %kind doesn't need
hardcoded magic (e.g. %{kind:--%kind}).

Note, if you use a non-default ghc_template, it will be up to you to ensure that the
result is compatible with your home directory configuration; if your home directory
is on a network share, you will want to arrange for build artifacts to live in a
local directory (this is part of what $XDG_CACHE_HOME is about).

@@@ what do -odir and -hidir do in --make mode?
@@@ recompile lock?

# # #

New API functions for the above:

- getXMonadDir is deprecated, and acts like getXMonadDataDir.
- getXMonadConfigDir produces the directory with sandbox.config.
    You should not put data files used by extensions with the xmonad config in XDG;
      this may be a sandbox directory.
- getXMonadDataDir produces the data directory.
- getXMonadWorkDir produces the cache directory.
- getXMonadHs produces the location of xmonad.hs. This may be in a sandbox.
- getXMonadProg produces the location of the main xmonad binary.
- getXMessageFileProg FILE produces the xmessage command line given a filename.
- getXMessageStrProg MESSAGE produces the xmessage command line given a short message.
- getXMonadKind produces the kind suffix (%kind).
- xmessage (Either String FilePath) convenience wrapper
    better, data XMsgType = ShortMsg String | FromFile FilePath
- expandXMonadString STR expands %-escapes in a string as if a filename
- expandPercentString STR MODE EXTRAS general form of above
    MODE is ExpNormal  (just expand it)
            ExpCommand (enables list comp and %\... forms, quoted result)
            ExpCompTgt (currently same as ExpNormal)
            ExpCompSrc (enables string splitting, produces list)
    EXTRAS is list of tuples defining additional vars for list comp
    produces list which is length 1 for all but ExpCompSrc
    throws ErrorCall on parse error
    this needs more thought re list comp semantics etc.

New command line parameters:

- -kind KIND specifies %kind for the compiled config.

# # #

This is the recompile script from my old newXMonad, supporting config sandboxes
(a different concept from build sandboxes like stack/nix/cabal). It's several
years out of date, and needs adjustment for the new tricks I want it to do.
Also it's wired for when I was using one config for standalone and another for
running xmonad in place of kwin in KDE3.

I'm afraid to ask how something like this is going to fit into ghc_template.
Possibly it'll end up like what I propose for recompile/restart, where the
main script is still hardcoded but uses %-escapes to handle the ghc invocation
and xmessage (below, kdialog).

(The script also handles the restart, and does so assuming it's running under
KDE's session manager.)

  cd "$HOME/.xmonad"
  ghc -W -v0 --make -i -ilib xmonad%kind.hs -o xmonad%kind-%arch-%os >xmonad%kind.errors 2>&1
  if [ $? -ne 0 ] || test -s xmonad%kind.errors; then
    cat xmonad%kind.errors >&2
    kdialog --title=xmonad%kind --sorry "$(cat xmonad%kind.errors)"
  else
    cd
    kill %pid
    sleep 1
    if [ x%kind != x ]; then
      xmonad%kind-%arch-%os && exit 0
    fi
    exec xmonad
    kdialog --title=xmonad%kind --sorry "fallback xmonad went missing?"
    exec /usr/bin/kwin
  fi
  exit 177
